# LG CNS Finance Tool - Spring Boot 마이그레이션 프로젝트 개발 가이드

> **📋 프로젝트 필수 참고 문서**
>
> 이 문서는 **프로젝트 전체 개발 방향 및 가이드**를 제공합니다.
> - 새로운 개발 세션 시작 시 반드시 이 문서를 먼저 읽으세요
> - 모든 개발은 이 문서의 우선순위와 설계를 따라야 합니다
> - 임의로 데이터 구조나 프로세스를 변경하지 마세요
>
> **GitHub 저장소:**
> - 기존 C# 프로젝트: https://github.com/scschwan/lgcns_1st_nosql.git
> - 신규 Spring Boot 프로젝트: https://github.com/scschwan/lg_cns_web.git

**문서 버전:** 2.0  
**최종 업데이트:** 2025-12-17  
**프로젝트 목표:** C# WinForms FinanceTool을 Spring Boot + React 웹 애플리케이션으로 마이그레이션

---

## 📋 목차
- [1. 프로젝트 개요](#1-프로젝트-개요)
- [2. 개발 우선순위 및 단계](#2-개발-우선순위-및-단계)
- [3. C# 메뉴 구조 (실제 코드)](#3-c-메뉴-구조-실제-코드)
- [4. Phase 2 상세 설명](#4-phase-2-상세-설명)
- [5. 데이터베이스 설계](#5-데이터베이스-설계)
- [6. 개발 스케줄](#6-개발-스케줄)
- [7. v2.0 수정 사항](#7-v20-수정-사항)

---

## 1. 프로젝트 개요

### 1.1 프로젝트 목표

**기존 시스템:**
- C# WinForms 기반 데스크톱 애플리케이션
- 로컬 Excel 파일 처리
- 단일 사용자 환경
- MongoDB 연동

**목표 시스템:**
- Spring Boot + React 웹 애플리케이션
- AWS 클라우드 기반 (ECS Fargate, DocumentDB, S3, Lambda)
- 다중 사용자 협업 지원
- 프로젝트 단위 데이터 관리
- 대용량 파일 병렬 처리 (SQS + Lambda)

### 1.2 핵심 마이그레이션 원칙

```
✅ DO (반드시 지켜야 할 원칙):
1. 기존 C# 비즈니스 로직 100% 재현
2. MongoDB 컬렉션 구조 그대로 유지
3. 7단계 프로세스 순서 및 동작 동일하게 구현
4. 필드명 그대로 사용 (data 내부 키도 sanitization 불필요)
5. UI 구성은 C# WinForms를 반응형 웹으로 재해석

❌ DON'T (하지 말아야 할 것):
1. 임의로 데이터 구조 변경
2. 비즈니스 로직 순서 변경
3. 컬렉션 관계 재설계
4. 필드명 변환 (sanitization)
5. 기존 기능 생략
```

---

## 2. 개발 우선순위 및 단계

```
Phase 0: 인증 및 프로젝트 관리 (최우선)
   ├─ 사용자 로그인/회원가입
   ├─ JWT 인증
   ├─ 프로젝트 생성/관리
   ├─ 프로젝트 공유 및 권한 관리
   └─ 프로젝트별 세션 격리

Phase 1: 대용량 파일 업로드 (우선)
   ├─ S3 Presigned URL 업로드
   ├─ SQS 메시지 큐
   ├─ Lambda Coordinator (파일 분석)
   ├─ Lambda Worker (병렬 파싱)
   └─ 진행률 추적 (Redis)

Phase 2: 비즈니스 로직 구현 (순차) ⭐ v2.0 수정됨
   ├─ Step 1: Multi File Upload
   ├─ Step 2: File Load
   ├─ Step 3: Preprocessing
   ├─ Step 4: Data Transform
   ├─ Step 5: Clustering (uc_Clustering) ⭐ 클러스터링 로직
   ├─ Step 6: Export (uc_Classification) ⭐⭐⭐ Excel 내보내기
   └─ Step 7: Detail Clustering (uc_DetailClustering)

Phase 3: UI 구현
   ├─ React 프로젝트 구조
   ├─ C# WinForms UI 재해석
   ├─ 반응형 템플릿 적용
   └─ 7단계 프로세스 화면
```

---

## 3. C# 메뉴 구조 (실제 코드)

### 3.1 Form1.cs 메뉴 구조

```csharp
// FinanceTool/Form1.cs
fileUploadToolStripMenuItem         → uc_multiFileUpload      (Step 1)
fileLoadToolStripMenuItem           → uc_fileLoad             (Step 2)
dataPreprocessingToolStripMenuItem  → uc_Preprocessing        (Step 3)
dataAnalToolStripMenuItem           → uc_dataTransform        (Step 4)
classificationToolStripMenuItem     → uc_clustering           (Step 5) ⭐
exportToolStripMenuItem             → uc_classification       (Step 6) ⭐⭐⭐
subClusteringToolStripMenuItem      → uc_detailClustering     (Step 7)
```

### 3.2 각 단계별 매핑

| Step | 메뉴명 | C# UserControl | 핵심 기능 |
|------|--------|----------------|----------|
| 1 | File Upload | uc_multiFileUpload | 세션 생성, 파일 업로드 |
| 2 | File Load | uc_fileLoad | Excel 파싱 → raw_data |
| 3 | Data Preprocessing | uc_Preprocessing | raw_data → process_data |
| 4 | Data Analysis | uc_dataTransform | 집계, 그룹핑 |
| 5 | **Classification** | **uc_clustering** | **KMeans 클러스터링** ⭐ |
| 6 | **Export** | **uc_classification** | **Excel 내보내기 + 세션 완료** ⭐⭐⭐ |
| 7 | Sub Clustering | uc_detailClustering | 세부 클러스터링 |

### 3.3 중요한 발견

**Step 5 완료 후 자동 이동:**
```csharp
// uc_Clustering.cs - complete_btn_Click()
userControlHandler.uc_classification.initUI();
form.LoadUserControl(
    userControlHandler.uc_classification, 
    form.exportToolStripMenuItem
);
```

→ Step 5 (Clustering) 완료 시 **Step 6 (Export = uc_classification)으로 자동 이동!**

---

## 4. Phase 2 상세 설명

### 4.1 Step 5 vs Step 6 명확한 구분

#### **Step 5: Clustering (uc_Clustering)**

**C# 코드에서 실제로 하는 일:**
```csharp
1. KMeans 알고리즘 실행
   - fit(), predict() 구현
   - 클러스터 중심 계산
   
2. 클러스터 병합 로직
   - MergeAndCreateNewCluster()
   - 자동 클러스터링
   
3. clustering_results 저장
   - MongoDB에 효율적으로 저장 (빠르게!)
   - process_data에 cluster_id, cluster_name 업데이트
   
4. UI 진행 상태
   - ProcessProgressForm (로컬 UI 진행률)
   
5. 완료 버튼 클릭
   - complete_btn_Click() → uc_classification으로 이동
```

**Spring Boot API:**
```http
POST /api/clustering/execute
Request: {
    "sessionId": "session-123",
    "projectId": "proj-123",
    "k": 5,
    "columns": ["금액", "거래처"]
}
Response: {
    "totalClusters": 5,
    "totalRecords": 150000
}

POST /api/clustering/merge
Request: {
    "sessionId": "session-123",
    "clusterIds": [1, 2]
}

GET /api/clustering/results
Query: sessionId, projectId
Response: {
    "clusters": [
        {
            "clusterId": 1,
            "clusterName": "고액 거래",
            "recordCount": 30000
        }
    ]
}
```

**핵심:** MongoDB clustering_results를 **얼마나 빠르고 효율적으로** 저장하는가!

---

#### **Step 6: Export (uc_Classification) ⭐⭐⭐**

**C# 코드에서 실제로 하는 일:**
```csharp
1. clustering_results 조회/수정
   - dataGridView에 클러스터 결과 표시
   - 클러스터명 변경 (dataGridView_classify_CellValueChanged)
   - 결과 필터링, 정렬
   
2. Excel 내보내기 ⭐⭐⭐
   - btn_save_excel_Click()
   - ExportToExcelAsync()
     * clustering_results → Excel 변환 (Apache POI)
     * S3 업로드
     * Presigned URL 생성
   - CreateServerBackupAsync()
     * 서버 백업 경로에 파일 복사
   
3. 세션 완료 상태 업데이트 ⭐
   - UpdateSessionCompletionAsync()
     * file_sessions.is_completed = true
     * file_sessions.export_path = s3Path
     * file_sessions.completed_at = now()
   
4. 세부 클러스터링 진입
   - DetailClustering_Click()
   - uc_detailClustering으로 이동
```

**Spring Boot API:**
```http
POST /api/export/excel
Request: {
    "sessionId": "session-123",
    "projectId": "proj-123",
    "columns": ["날짜", "금액", "거래처", "cluster_name"]
}
Response: {
    "downloadUrl": "https://s3.../exports/session-123/result_20251217.xlsx",
    "fileSize": 5242880,
    "exportedAt": "2025-12-17T10:30:00Z"
}

PUT /api/sessions/{sessionId}/complete
Request: {
    "exportPath": "s3://finance-bucket/exports/session-123/result.xlsx"
}
Response: {
    "sessionId": "session-123",
    "isCompleted": true,
    "completedAt": "2025-12-17T10:30:00Z"
}

PUT /api/clustering/results/{clusterId}/name
Request: {
    "clusterName": "고액 거래 - 수정됨"
}

GET /api/clustering/results
Query: sessionId, projectId, page, size
Response: {
    "data": [...],
    "pagination": {...}
}

GET /api/clustering/results/hidden
Query: sessionId, projectId
Response: {
    "hiddenRecords": [...]
}
```

**핵심:**
1. **Excel 내보내기** (MongoDB → Excel → S3)
2. **세션 완료 처리** (is_completed = true)
3. **서버 백업 생성**

---

### 4.2 전체 프로세스 흐름

```
Step 1: Multi File Upload
   → POST /api/sessions (세션 생성)
   → POST /api/sessions/{sessionId}/files (파일 업로드)

Step 2: File Load
   → Phase 1 Lambda 병렬 처리 (Excel → raw_data)
   → GET /api/data (페이징 조회)
   → GET /api/data/summary (집계 요약)

Step 3: Preprocessing
   → POST /api/preprocessing/validate (검증)
   → POST /api/preprocessing/clean (정제)
   → raw_data → process_data

Step 4: Data Transform
   → POST /api/transform/aggregate (집계 계산)
   → process_data 변환

Step 5: Clustering (uc_Clustering) ⭐
   → POST /api/clustering/execute (클러스터링 실행)
   → POST /api/clustering/merge (클러스터 병합)
   → clustering_results 저장
   → process_data에 cluster_id 업데이트
   → 완료 시 Step 6으로 자동 이동

Step 6: Export (uc_Classification) ⭐⭐⭐
   → GET /api/clustering/results (결과 조회)
   → PUT /api/clustering/results/{clusterId}/name (클러스터명 수정)
   → POST /api/export/excel (Excel 내보내기)
   → PUT /api/sessions/{sessionId}/complete (세션 완료)

Step 7: Detail Clustering
   → POST /api/clustering/{clusterId}/sub-clusters (하위 클러스터 생성)
   → GET /api/clustering/{clusterId}/sub-clusters (조회)
```

---

## 5. 데이터베이스 설계

### 5.1 file_sessions (수정됨 - v2.0)

```javascript
{
    "_id": ObjectId("..."),
    "session_id": "session-uuid-456",
    "project_id": "proj-uuid-123",
    "created_by": ObjectId("..."),
    "uploaded_files": [
        {
            "file_id": ObjectId("..."),
            "file_name": "재무데이터_2025.xlsx",
            "file_size": 52428800,
            "uploaded_at": ISODate("2025-12-16T10:00:00Z")
        }
    ],
    
    // ⭐ v2.0 추가 필드 (Step 6에서 업데이트)
    "is_completed": false,                // Step 6에서 true로 변경
    "export_path": null,                  // Step 6에서 S3 경로 저장
    "completed_at": null,                 // Step 6에서 완료 시간 기록
    
    "created_at": ISODate("2025-12-16T10:00:00Z"),
    "last_accessed_at": ISODate("2025-12-16T11:00:00Z")
}
```

### 5.2 clustering_results

```javascript
{
    "_id": ObjectId("..."),
    "project_id": "proj-uuid-123",
    "session_id": "session-uuid-456",
    "cluster_id": 1,
    "cluster_name": "고액 거래",
    "cluster_center": [1500000, 5],       // K-Means 중심점
    "record_count": 30000,
    "created_at": ISODate("...")
}
```

### 5.3 process_data (cluster_id 추가)

```javascript
{
    "_id": ObjectId("..."),
    "project_id": "proj-uuid-123",
    "raw_data_id": ObjectId("..."),
    "data": {
        "날짜": "2025-01-15",
        "금액": 1500000,
        "거래처": "ABC 주식회사"
    },
    "cluster_id": 1,                      // Step 5에서 추가
    "cluster_name": "고액 거래"           // Step 5에서 추가
}
```

---

## 6. 개발 스케줄

```
Phase 0: 인증 및 프로젝트 관리 (1주)
Phase 1: 대용량 파일 업로드 (1주)
Phase 2: 비즈니스 로직 구현 (3주)
  - Step 1: 1일
  - Step 2: 2일
  - Step 3: 2일
  - Step 4: 2일
  - Step 5: 2일 (클러스터링 로직)
  - Step 6: 3일 ⭐ Excel 내보내기 핵심
  - Step 7: 1.5일
Phase 3: UI 구현 (2주)

총 10주 (약 2.5개월)
```

---

## 7. v2.0 수정 사항

### 7.1 주요 변경 내용 (2025-12-17)

#### **1. Step 5 (Clustering) 수정**

**기존 (v1.0 - 틀림):**
```
❌ 비동기 API (CompletableFuture, Redis 진행률)
❌ POST /api/clustering/start
❌ GET /api/clustering/status/{jobId}
❌ GET /api/clustering/result/{jobId}
```

**수정 (v2.0 - 정확):**
```
✅ 클러스터링 로직에 집중:
   - KMeans 알고리즘 (fit, predict)
   - 클러스터 병합 로직
   - clustering_results 빠른 저장
   - process_data에 cluster_id 업데이트

✅ API:
   - POST /api/clustering/execute
   - POST /api/clustering/merge
   - GET /api/clustering/results
```

**변경 이유:** 비동기 처리는 불필요! 클러스터링 로직과 MongoDB 효율적 저장에 집중해야 함.

---

#### **2. Step 6 (Export) 명확화**

**기존 (v1.0 - 모호함):**
```
❌ Step 7 (Detail Clustering)에 Excel 내보내기 배치
❌ Export 역할 불명확
```

**수정 (v2.0 - 정확):**
```
✅ Step 6 = Export = uc_Classification:
   - Excel 내보내기 (MongoDB → Excel → S3)
   - 세션 완료 처리 (is_completed = true)
   - 서버 백업 생성
   - 클러스터명 수정

✅ API:
   - POST /api/export/excel
   - PUT /api/sessions/{sessionId}/complete
   - PUT /api/clustering/results/{clusterId}/name
```

**변경 이유:** GitHub C# 코드 분석 결과, Excel 내보내기는 Step 6 (uc_Classification)에서 수행됨!

---

#### **3. file_sessions 구조 추가**

```javascript
{
    "is_completed": false,   // ⭐ Step 6에서 true로 변경
    "export_path": null,     // ⭐ Step 6에서 S3 경로 저장
    "completed_at": null     // ⭐ Step 6에서 완료 시간 기록
}
```

**변경 이유:** Step 6에서 세션 완료 처리를 위해 필요한 필드들.

---

#### **4. C# 메뉴 구조 명확화**

```
classificationToolStripMenuItem → uc_clustering (Step 5)
exportToolStripMenuItem → uc_classification (Step 6) ⭐
```

**변경 이유:** 메뉴명과 UserControl 이름이 혼란스러웠으나, 실제 C# 코드로 확인함.

---

### 7.2 v1.0 vs v2.0 비교표

| 항목 | v1.0 (틀림) | v2.0 (정확) |
|------|------------|------------|
| Step 5 핵심 | 비동기 API | 클러스터링 로직 |
| Step 5 API | POST /api/clustering/start | POST /api/clustering/execute |
| Step 6 정의 | 모호함 | Excel 내보내기 + 세션 완료 |
| Excel 내보내기 | Step 7? | **Step 6** ⭐ |
| 세션 완료 처리 | 없음 | **Step 6** ⭐ |
| file_sessions 필드 | 없음 | is_completed, export_path 추가 |

---

## 8. 참고 자료

### 8.1 GitHub 저장소

- **기존 C# 프로젝트:** https://github.com/scschwan/lgcns_1st_nosql.git
    - Form1.cs (메뉴 구조)
    - uc_Clustering.cs (Step 5)
    - uc_Classification.cs (Step 6 - Excel 내보내기)
    - uc_DetailClustering.cs (Step 7)

- **신규 Spring Boot 프로젝트:** https://github.com/scschwan/lg_cns_web.git

### 8.2 AWS 인프라 문서

- **AWS 아키텍처:** 01-aws-architecture-and-cost.md
- **서비스 아키텍처:** 02-service-architecture.md
- **프로세스 플로우:** 03-process-flow.md
- **인프라 구축:** 04-aws-infrastructure-setup.md
- **개발 환경 구축:** 05-development-environment-setup.md

---

**문서 버전:** 2.0  
**최종 업데이트:** 2025-12-17 02:40 KST  
**작성자:** dhkim  
**프로젝트 기간:** 2025-12 ~ 2026-02 (약 10주)

> **⚠️ v2.0 주요 변경사항 요약:**
>
> 1. **Step 5 (Clustering):** 비동기 API 제거 → 클러스터링 로직에 집중
> 2. **Step 6 (Export):** Excel 내보내기 + 세션 완료 처리 명확화
> 3. **file_sessions:** is_completed, export_path, completed_at 필드 추가
> 4. **C# 메뉴 구조:** Form1.cs 코드 기반으로 정확하게 매핑
>
> **GitHub 코드 분석 기반으로 정확하게 수정했습니다!**